{% extends 'caisse/layout.html.twig' %}

{% block title %}Historique des Ventes{% endblock %}

{% block body %}
    <div class="container-fluid p-4">
        <h1 class="mb-4">Historique des Ventes</h1>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form method="get" class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label for="start_date" class="form-label">Début</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" value="{{ startDate }}">
                    </div>
                    <div class="col-md-2">
                        <label for="end_date" class="form-label">Fin</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" value="{{ endDate }}">
                    </div>
                    <div class="col-md-3">
                        <label for="client_select" class="form-label">Client</label>
                        <select id="client_select" name="client" placeholder="Tous les clients..." autocomplete="off">
                            {% if currentClient %}
                                <option value="{{ currentClient.id }}" selected>{{ currentClient.nom|upper }} {{ currentClient.prenom|capitalize }}</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-5 d-flex align-items-end gap-2">
                        <button type="button" id="btn-today" class="btn btn-outline-primary" title="Aujourd'hui"><i class="fas fa-calendar-day"></i></button>
                        <button type="submit" class="btn btn-primary flex-grow-1"><i class="fas fa-filter me-2"></i>Filtrer</button>
                        <a href="{{ path('app_vente_index') }}" class="btn btn-secondary" title="Réinitialiser"><i class="fas fa-undo"></i></a>
                    </div>
                </form>
            </div>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Tom Select for Client Search
                new TomSelect('#client_select', {
                    valueField: 'value',
                    labelField: 'label',
                    searchField: 'label',
                    load: function(query, callback) {
                        var url = '{{ path("app_caisse_client_search") }}?q=' + encodeURIComponent(query);
                        fetch(url)
                            .then(response => response.json())
                            .then(json => {
                                callback(json);
                            }).catch(()=>{
                                callback();
                            });
                    },
                    render: {
                        option: function(item, escape) {
                            return '<div>' + escape(item.label) + '</div>';
                        },
                        item: function(item, escape) {
                            return '<div>' + escape(item.label) + '</div>';
                        }
                    }
                });

                var btn = document.getElementById('btn-today');
                var startInput = document.getElementById('start_date');
                var endInput = document.getElementById('end_date');
                var form = btn ? btn.closest('form') : null;
                if (btn && startInput && endInput && form) {
                    btn.addEventListener('click', function() {
                        var today = new Date();
                        var y = today.getFullYear();
                        var m = String(today.getMonth() + 1).padStart(2, '0');
                        var d = String(today.getDate()).padStart(2, '0');
                        var iso = y + '-' + m + '-' + d;
                        startInput.value = iso;
                        endInput.value = iso;
                        form.submit();
                    });
                }
            });
        </script>

        <!-- Modal Annulation -->
        <div class="modal fade" id="annulationModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Annuler la vente</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="annulationForm" onsubmit="event.preventDefault(); submitAnnulation();">
                            <input type="hidden" id="annulationVenteId">
                            <div class="mb-3">
                                <label for="annulationMontant" class="form-label">Montant à annuler</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" class="form-control" id="annulationMontant" required>
                                    <span class="input-group-text">€</span>
                                </div>
                                <div class="form-text">Par défaut le montant de la vente, mais modifiable.</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Type d'annulation</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="annulationType" id="typeRemboursement" value="remboursement" checked>
                                    <label class="form-check-label" for="typeRemboursement">
                                        Remboursement
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="annulationType" id="typeAvoir" value="avoir">
                                    <label class="form-check-label" for="typeAvoir">
                                        Avoir (génère un code unique)
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="annulationMotif" class="form-label">Motif</label>
                                <textarea class="form-control" id="annulationMotif" rows="3" required placeholder="Ex: Avoir, erreur de saisie..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="annulationPin" class="form-label">Code PIN Administrateur</label>
                                <input type="password" class="form-control" id="annulationPin" required maxlength="4" pattern="\d{4}" inputmode="numeric" autocomplete="off">
                            </div>
                            <div id="annulationError" class="alert alert-danger d-none"></div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                        <button type="button" class="btn btn-danger" onclick="submitAnnulation()">Valider l'annulation</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            var annulationModal;
            
            document.addEventListener('DOMContentLoaded', function() {
                var modalEl = document.getElementById('annulationModal');
                if (modalEl) {
                    annulationModal = new bootstrap.Modal(modalEl);
                    modalEl.addEventListener('shown.bs.modal', function () {
                        document.getElementById('annulationPin').focus();
                    });
                }
            });

            function openAnnulationModal(id, montant) {
                document.getElementById('annulationVenteId').value = id;
                document.getElementById('annulationMontant').value = montant;
                document.getElementById('annulationMotif').value = '';
                document.getElementById('annulationPin').value = '';
                document.getElementById('annulationError').classList.add('d-none');
                document.getElementById('annulationError').textContent = '';
                
                if (annulationModal) {
                    annulationModal.show();
                }
            }

            function submitAnnulation() {
                const id = document.getElementById('annulationVenteId').value;
                const montant = document.getElementById('annulationMontant').value;
                const motif = document.getElementById('annulationMotif').value;
                const pin = document.getElementById('annulationPin').value;
                const type = document.querySelector('input[name="annulationType"]:checked').value;
                const errorDiv = document.getElementById('annulationError');

                if (!montant || !motif || !pin) {
                    errorDiv.textContent = 'Tous les champs sont obligatoires.';
                    errorDiv.classList.remove('d-none');
                    return;
                }

                // Disable button to prevent double submit
                const btn = document.querySelector('#annulationModal .btn-danger');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';

                fetch('/caisse/ventes/' + id + '/annuler', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        montant: montant,
                        motif: motif,
                        pin: pin,
                        type: type
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        errorDiv.textContent = data.message || 'Une erreur est survenue';
                        errorDiv.classList.remove('d-none');
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    errorDiv.textContent = 'Une erreur de communication est survenue';
                    errorDiv.classList.remove('d-none');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                });
            }
        </script>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Mode Paiement</th>
                                <th>Articles</th>
                                <th class="text-end">Commission</th>
                                <th class="text-end">Chiffre d'affaire</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vente in ventes %}
                                {% set totalCommission = 0 %}
                                
                                {# Calculate Non-Monetary Amount (BonAchat, Fidelite) #}
                                {% set nonMonetaryAmount = 0 %}
                                {% if vente.paiements|length > 0 %}
                                    {% for paiement in vente.paiements %}
                                        {% if paiement.methode in ['BonAchat', 'Fidelite'] %}
                                            {% set nonMonetaryAmount = nonMonetaryAmount + paiement.montant %}
                                        {% endif %}
                                    {% endfor %}
                                {% elseif vente.modePaiement in ['BonAchat', 'Fidelite'] %}
                                    {% set nonMonetaryAmount = vente.montantTotal %}
                                {% endif %}

                                {# Calculate Real CA #}
                                {% set realCA = max(0, vente.montantTotal - nonMonetaryAmount) %}
                                
                                {# Calculate Ratio for Commission #}
                                {% set ratio = 1 %}
                                {% if vente.montantTotal > 0 %}
                                    {% set ratio = realCA / vente.montantTotal %}
                                {% endif %}

                                {% for ligne in vente.ligneVentes %}
                                    {% set commissionRate = 0 %}
                                    {% set isDepot = false %}
                                    
                                    {% if ligne.article and ligne.article.fournisseur and ligne.article.fournisseur.clientDepotVente %}
                                        {% set isDepot = true %}
                                        {% if ligne.article.fournisseur.depotVente %}
                                            {% set commissionRate = ligne.article.fournisseur.depotVente.commission %}
                                        {% endif %}
                                    {% endif %}

                                    {% if isDepot %}
                                        {% set commissionAmount = ligne.prixUnitaire * ligne.quantite * commissionRate / 100 %}
                                        {% set totalCommission = totalCommission + commissionAmount %}
                                    {% else %}
                                        {# Non-depot article (Shop stock) or Prestation: 100% commission #}
                                        {% set totalCommission = totalCommission + (ligne.prixUnitaire * ligne.quantite) %}
                                    {% endif %}
                                {% endfor %}

                                {% set totalCommission = totalCommission * ratio %}

                                <tr>
                                    <td>{{ vente.dateVente|date('d/m/Y H:i') }}</td>
                                    <td>
                                        {% if vente.client %}
                                            {{ vente.client.prenom }} {{ vente.client.nom }}
                                        {% else %}
                                            <span class="text-muted">Client inconnu</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if vente.paiements|length > 0 %}
                                            {% for paiement in vente.paiements %}
                                                <div class="mb-1">
                                                    <span class="badge bg-{{ paiement.methode == 'CB' ? 'success' : (paiement.methode == 'Espece' ? 'warning' : 'info') }}">
                                                        {{ paiement.methode }}
                                                    </span>
                                                    <span class="small">{{ paiement.montant|number_format(2, ',', ' ') }} €</span>
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            <span class="badge bg-{{ vente.modePaiement == 'CB' ? 'success' : (vente.modePaiement == 'Espece' ? 'warning' : 'info') }}">
                                                {{ vente.modePaiement }}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <ul class="list-unstyled mb-0 small">
                                            {% for ligne in vente.ligneVentes %}
                                                <li>
                                                    {{ ligne.quantite }}x {{ ligne.nom }}
                                                    <span class="text-muted">({{ ligne.prixUnitaire }} €)</span>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </td>
                                    <td class="text-end">
                                        {{ totalCommission|number_format(2, ',', ' ') }} €
                                    </td>
                                    <td class="text-end fw-bold">
                                        {{ realCA|number_format(2, ',', ' ') }} €
                                        {% if vente.commentaire %}
                                            <br><small class="text-danger fst-italic">{{ vente.commentaire }}</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if vente.montantTotal > 0 and not vente.isAnnule and vente.isCommission100 %}
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="openAnnulationModal({{ vente.id }}, {{ vente.montantTotal }})" title="Annuler cette vente">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                        {% elseif vente.isAnnule %}
                                            <span class="badge bg-danger">ANNULÉE</span>
                                        {% endif %}
                                        <a href="{{ path('app_vente_ticket', {'id': vente.id}) }}" target="_blank" class="btn btn-outline-dark btn-sm ms-1" title="Imprimer le ticket">
                                            <i class="fas fa-ticket-alt"></i>
                                        </a>
                                        <a href="{{ path('app_vente_facture', {'id': vente.id}) }}" class="btn btn-outline-dark btn-sm ms-1" title="Facture">
                                            <i class="fas fa-file-invoice"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="7" class="text-center py-4 text-muted">
                                        Aucune vente trouvée pour cette période.
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-light fw-bold">
                            <tr>
                                <td colspan="4" class="text-end text-uppercase">Totaux</td>
                                <td class="text-end">{{ globalTotalCommission|number_format(2, ',', ' ') }} €</td>
                                <td class="text-end">{{ globalTotalMontantCaisse|number_format(2, ',', ' ') }} €</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="text-muted small">
                        Page {{ page }} / {{ pagesCount }} — {{ totalResults }} ventes
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item {{ page <= 1 ? 'disabled' : '' }}">
                                <a class="page-link" href="{{ path('app_vente_index', {'page': page - 1, 'start_date': startDate, 'end_date': endDate, 'client': currentClient ? currentClient.id : null}) }}">Précédent</a>
                            </li>
                            <li class="page-item {{ page >= pagesCount ? 'disabled' : '' }}">
                                <a class="page-link" href="{{ path('app_vente_index', {'page': page + 1, 'start_date': startDate, 'end_date': endDate, 'client': currentClient ? currentClient.id : null}) }}">Suivant</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
