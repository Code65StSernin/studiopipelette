{% extends 'caisse/layout.html.twig' %}

{% block title %}Tableau de bord - Caisse{% endblock %}

{% block body %}
<div class="container-fluid p-0" style="max-width: 100%;">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 mb-0 text-gray-800">Tableau de bord Activités</h1>
    </div>

    {# --- BARRE DE FILTRES --- #}
    <div class="card mb-3 bg-light border-secondary">
        <div class="card-body p-2">
            <form method="get" class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <div class="d-flex align-items-center gap-2">
                    <label class="text-muted mb-0 small">Période :</label>
                    <input type="date" name="from" class="form-control form-control-sm border-secondary" value="{{ filters.from }}">
                    <span class="text-muted">à</span>
                    <input type="date" name="to" class="form-control form-control-sm border-secondary" value="{{ filters.to }}">
                </div>
                
                <div class="d-flex align-items-center gap-2">
                    <label class="text-muted mb-0 small">Graphique :</label>
                    <select name="salesPeriod" class="form-select form-select-sm border-secondary" style="width: auto;">
                        <option value="day" {{ filters.salesPeriod == 'day' ? 'selected' }}>Par Jour</option>
                        <option value="month" {{ filters.salesPeriod == 'month' ? 'selected' }}>Par Mois</option>
                        <option value="year" {{ filters.salesPeriod == 'year' ? 'selected' }}>Par Année</option>
                    </select>
                    <button type="submit" class="btn btn-primary btn-sm px-3">
                        <i class="fa fa-filter"></i> Appliquer
                    </button>
                </div>
            </form>
        </div>
    </div>

    {# --- LIGNE 1 : KPI GLOBAUX --- #}
    <div class="row g-3 mb-3">
        {# CA GLOBAL #}
        <div class="col-md-3">
            <div class="card h-100 bg-primary text-white shadow-sm border-0">
                <div class="card-body p-3">
                    <h6 class="text-white-50 text-uppercase small mb-1">Chiffre d'Affaires Global</h6>
                    <h2 class="mb-0 fw-bold">{{ stats.caGlobal|number_format(2, ',', ' ') }} €</h2>
                    <div class="mt-2 small d-flex justify-content-between text-white-50">
                        <span>En Ligne : {{ stats.caOnline|number_format(2, ',', ' ') }} €</span>
                        <span>Caisse : {{ stats.caCaisse|number_format(2, ',', ' ') }} €</span>
                    </div>
                </div>
            </div>
        </div>

        {# RÉSULTATS #}
        <div class="col-md-3">
            <div class="card h-100 border-secondary shadow-sm">
                <div class="card-body p-3">
                    <h6 class="text-muted text-uppercase small mb-1">Résultat Net</h6>
                    <h3 class="mb-0 {{ stats.resultatNet >= 0 ? 'text-success' : 'text-danger' }}">
                        {{ stats.resultatNet|number_format(2, ',', ' ') }} €
                    </h3>
                    <div class="mt-2 small text-muted">
                        Résultat Brut : <span class="text-dark">{{ stats.resultatBrut|number_format(2, ',', ' ') }} €</span>
                    </div>
                </div>
            </div>
        </div>

        {# CHARGES #}
        <div class="col-md-3">
            <div class="card h-100 border-secondary shadow-sm">
                <div class="card-body p-3">
                    <h6 class="text-muted text-uppercase small mb-1">Charges à Payer</h6>
                    <h3 class="mb-0 text-warning">{{ stats.chargesAPayer|number_format(2, ',', ' ') }} €</h3>
                    <div class="mt-2 small text-muted">
                        Dont Impôt Revenu : {{ stats.impotRevenu|number_format(2, ',', ' ') }} €
                    </div>
                </div>
            </div>
        </div>

        {# TRÉSORERIE #}
        <div class="col-md-3">
            <div class="card h-100 border-secondary shadow-sm">
                <div class="card-body p-3">
                    <h6 class="text-muted text-uppercase small mb-1">Trésorerie Réelle</h6>
                    <h3 class="mb-0 text-info">{{ stats.tresorerieReelle|number_format(2, ',', ' ') }} €</h3>
                    <div class="mt-2 small text-muted">
                        Théorique : {{ stats.tresorerieTheorique|number_format(2, ',', ' ') }} €
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# --- LIGNE 2 : DÉTAILS FINANCIERS --- #}
    <div class="row g-3 mb-3">
        <div class="col-12">
            <div class="card border-secondary shadow-sm">
                <div class="card-body p-2 d-flex flex-wrap justify-content-around align-items-center text-center">
                    <div class="p-2 border-end border-secondary">
                        <small class="text-muted d-block">URSSAF BIC</small>
                        <span class="fw-bold">{{ stats.chargesBic|number_format(2, ',', ' ') }} €</span>
                    </div>
                    <div class="p-2 border-end border-secondary">
                        <small class="text-muted d-block">URSSAF BNC</small>
                        <span class="fw-bold">{{ stats.chargesBnc|number_format(2, ',', ' ') }} €</span>
                    </div>
                    <div class="p-2 border-end border-secondary">
                        <small class="text-muted d-block">CPF</small>
                        <span class="fw-bold">{{ stats.chargesCpf|number_format(2, ',', ' ') }} €</span>
                    </div>
                    <div class="p-2 border-end border-secondary">
                        <small class="text-muted d-block">Total Charges Sociales</small>
                        <span class="fw-bold text-warning">{{ stats.chargesSociales|number_format(2, ',', ' ') }} €</span>
                    </div>
                    <div class="p-2">
                        <small class="text-muted d-block">Dépenses (Période)</small>
                        <span class="fw-bold text-danger">{{ stats.depensesTotal|number_format(2, ',', ' ') }} €</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# --- LIGNE 3 : GRAPHIQUES ET TOPS --- #}
    <div class="row g-3">
        {# GRAPHIQUE #}
        <div class="col-lg-7">
            <div class="card border-secondary shadow-sm h-100">
                <div class="card-header border-0 bg-transparent d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Évolution du Chiffre d'Affaires</h6>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="chartType" id="chartLine" autocomplete="off" checked onclick="toggleChart('line')">
                        <label class="btn btn-outline-secondary" for="chartLine"><i class="fa fa-chart-line"></i> Ligne</label>

                        <input type="radio" class="btn-check" name="chartType" id="chartPie" autocomplete="off" onclick="toggleChart('pie')">
                        <label class="btn btn-outline-secondary" for="chartPie"><i class="fa fa-chart-pie"></i> Répartition</label>
                    </div>
                </div>
                <div class="card-body">
                    <div style="height: 300px; position: relative;">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        {# TOPS ARTICLES #}
        <div class="col-lg-5">
            <div class="card border-secondary shadow-sm h-100">
                <div class="card-header border-0 bg-transparent">
                    <ul class="nav nav-tabs card-header-tabs" id="topTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active text-dark" id="online-tab" data-bs-toggle="tab" data-bs-target="#online" type="button" role="tab">Top En Ligne</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link text-dark" id="caisse-tab" data-bs-toggle="tab" data-bs-target="#caisse" type="button" role="tab">Top Caisse</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body p-0">
                    <div class="tab-content" id="topTabsContent">
                        {# TAB ONLINE #}
                        <div class="tab-pane fade show active" id="online" role="tabpanel">
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="sticky-top bg-light">
                                        <tr>
                                            <th>Article</th>
                                            <th class="text-end">Qté</th>
                                            <th class="text-end">CA</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in topOnline %}
                                            <tr>
                                                <td>{{ row.designation }}</td>
                                                <td class="text-end">{{ row.quantite }}</td>
                                                <td class="text-end">{{ (row.ca / 100)|number_format(2, ',', ' ') }} €</td>
                                            </tr>
                                        {% else %}
                                            <tr><td colspan="3" class="text-center text-muted">Aucune donnée</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {# TAB CAISSE #}
                        <div class="tab-pane fade" id="caisse" role="tabpanel">
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="sticky-top bg-light">
                                        <tr>
                                            <th>Article</th>
                                            <th class="text-end">Qté</th>
                                            <th class="text-end">CA</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in topCaisse %}
                                            <tr>
                                                <td>{{ row.designation }}</td>
                                                <td class="text-end">{{ row.quantite }}</td>
                                                <td class="text-end">{{ (row.ca / 100)|number_format(2, ',', ' ') }} €</td>
                                            </tr>
                                        {% else %}
                                            <tr><td colspan="3" class="text-center text-muted">Aucune donnée</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {# --- RUPTURES DE STOCK (Optionnel, si critique) --- #}
    {% if outOfStockArticles is not empty %}
    <div class="alert alert-warning mt-3 mb-0 d-flex align-items-center">
        <i class="fa fa-exclamation-triangle me-2"></i>
        <div>
            <strong>Attention :</strong> {{ stats.outOfStockSizes }} taille(s) en rupture de stock.
            <small>({{ outOfStockArticles|length }} articles concernés)</small>
        </div>
    </div>
    {% endif %}

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('salesChart').getContext('2d');
    
    // Données Line Chart
    const lineData = {
        labels: {{ chart.labels|json_encode|raw }},
        datasets: [
            {
                label: 'En Ligne',
                data: {{ chart.online|json_encode|raw }},
                borderColor: '#0d6efd', // Primary
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            },
            {
                label: 'Caisse',
                data: {{ chart.caisse|json_encode|raw }},
                borderColor: '#198754', // Success (Green)
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            }
        ]
    };

    // Données Pie Chart (Répartition Global)
    const pieData = {
        labels: ['En Ligne', 'Caisse'],
        datasets: [{
            data: [{{ stats.caOnline }}, {{ stats.caCaisse }}],
            backgroundColor: ['#0d6efd', '#198754'],
            hoverOffset: 4
        }]
    };

    let currentChart;

    window.toggleChart = function(type) {
        if (currentChart) {
            currentChart.destroy();
        }

        if (type === 'line') {
            currentChart = new Chart(ctx, {
                type: 'line',
                data: lineData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Important pour le conteneur
                    plugins: {
                        legend: { labels: { color: 'black' } } // Changed to black for light theme
                    },
                    scales: {
                        x: { ticks: { color: '#495057' }, grid: { color: '#e9ecef' } }, // Adapted colors
                        y: { ticks: { color: '#495057' }, grid: { color: '#e9ecef' }, beginAtZero: true }
                    }
                }
            });
        } else {
            currentChart = new Chart(ctx, {
                type: 'doughnut', // Plus joli que Pie
                data: pieData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'black' } }
                    }
                }
            });
        }
    };

    // Init default chart
    toggleChart('line');
});
</script>
{% endblock %}
