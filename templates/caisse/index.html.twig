{% extends 'caisse/layout.html.twig' %}

{% block title %}Caisse - {{ (isTarifView or isArticleView) ? (currentSousCategorie ? currentSousCategorie.nom : (currentShopCategory ? currentShopCategory.nom : '')) : ((isSousCategorieView or isShopCategoryView) ? currentCategorie.nom : 'Catégories') }}{% endblock %}

{% block body %}
    <div class="row h-100 g-0">
        <div class="col-9 pe-3">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>
                    {% if isTarifView %}
                         <span class="text-muted">Sous-catégorie :</span> {{ currentSousCategorie.nom }}
                    {% elseif isArticleView %}
                        {% if currentShopCategory %}
                            <span class="text-muted">Catégorie Boutique :</span> {{ currentShopCategory.nom }}
                        {% elseif currentSousCategorie %}
                            <span class="text-muted">Sous-catégorie :</span> {{ currentSousCategorie.nom }}
                        {% endif %}
                    {% elseif isSousCategorieView or isShopCategoryView %}
                        <span class="text-muted">Catégorie :</span> {{ currentCategorie.nom }}
                    {% else %}
                        Catégories de vente
                    {% endif %}
                </h1>
                {% if isTarifView %}
                     <a href="{{ path('app_caisse', {'categorie': currentCategorie.id}) }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Retour aux sous-catégories
                    </a>
                {% elseif isArticleView %}
                    {% if currentShopCategory %}
                        <a href="{{ path('app_caisse', {'categorie': currentCategorie.id}) }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Retour aux catégories
                        </a>
                    {% else %}
                        <a href="{{ path('app_caisse', {'categorie': currentCategorie.id}) }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Retour aux sous-catégories
                        </a>
                    {% endif %}
                {% elseif isSousCategorieView or isShopCategoryView %}
                    <a href="{{ path('app_caisse') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Retour aux catégories
                    </a>
                {% endif %}
            </div>

            <div class="{{ (isSousCategorieView or isShopCategoryView or isTarifView or isArticleView) ? 'row row-cols-auto g-4' : 'row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-4' }}">
                {% for item in items %}
                    <div class="col">
                        {% set link = '#' %}
                        {% if not isSousCategorieView and not isShopCategoryView and not isTarifView and not isArticleView %}
                            {% set link = path('app_caisse', {'categorie': item.id}) %}
                        {% elseif isSousCategorieView %}
                            {% set link = path('app_caisse', {'sous_categorie': item.id}) %}
                        {% elseif isShopCategoryView %}
                            {% set link = path('app_caisse', {'categorie': currentCategorie.id, 'categorie_shop': item.id}) %}
                        {% endif %}
                        
                        {% set onclick = '' %}
                        {% set ondblclick = '' %}
                        {% set cardClass = '' %}
                        {% set opacityStyle = '' %}
                        {% set imageClass = '' %}
                        {% set imageStyle = '' %}
                        {% set isOutOfStock = false %}
                        {% set outOfStockAction = '' %}
                        
                        {% if isTarifView %}
                            {% set onclick = "addToCart(" ~ item.id ~ ", '" ~ item.nom|escape('js') ~ "', " ~ item.tarif ~ ", 'tarif', null);" %}
                        {% elseif isArticleView %}
                            {% set firstTaille = item.tailles|first %}
                            {% if firstTaille %}
                                {% if firstTaille.stock is defined and firstTaille.stock <= 0 %}
                                    {# Rupture de stock : grisé, désactivé, bouton de vente forcée #}
                                    {% set isOutOfStock = true %}
                                    {% set onclick = "" %}
                                    {% set outOfStockAction = "openPinModal(" ~ item.id ~ ", '" ~ item.nom|escape('js') ~ "', " ~ firstTaille.prix ~ ", 'article', '" ~ firstTaille.taille|escape('js') ~ "');" %}
                                    {% set imageClass = 'grayscale' %}
                                    {% set imageStyle = 'opacity: 0.5;' %}
                                {% else %}
                                    {% set onclick = "addToCart(" ~ item.id ~ ", '" ~ item.nom|escape('js') ~ "', " ~ firstTaille.prix ~ ", 'article', '" ~ firstTaille.taille|escape('js') ~ "');" %}
                                {% endif %}
                            {% endif %}
                        {% endif %}

                        {% if link != '#' %}
                            {% set onclick = "window.location.href='" ~ link ~ "';" %}
                        {% endif %}

                        <div role="button" 
                           class="card {{ (isSousCategorieView or isShopCategoryView or isTarifView or isArticleView) ? 'border-0' : 'h-100 border-0' }} text-decoration-none shadow-sm item-card position-relative {{ cardClass }}"
                           style="cursor: pointer; {{ (isTarifView or isArticleView) ? 'width: 200px; height: 200px;' : ((isSousCategorieView or isShopCategoryView) ? 'width: 250px; height: 250px;' : '') }} {{ opacityStyle }}"
                           {% if onclick %}onclick="{{ onclick }}"{% endif %}>
                            
                            {% if isOutOfStock %}
                                <button class="btn btn-danger position-absolute top-50 start-50 translate-middle shadow rounded-circle d-flex align-items-center justify-content-center" 
                                        style="z-index: 10; width: 60px; height: 60px; opacity: 1;"
                                        onclick="event.preventDefault(); event.stopPropagation(); {{ outOfStockAction }}">
                                    <i class="fas fa-ban fa-2x"></i>
                                </button>
                            {% endif %}
                            
                            {% set imagePath = null %}
                            {% set bgColor = null %}
                            
                            {% if isTarifView %}
                                 {% if item.image %}
                                     {% set imagePath = asset('uploads/images/tarifs/' ~ item.image) %}
                                 {% elseif currentSousCategorie.image %}
                                     {% set imagePath = asset('uploads/images/sous_categories/' ~ currentSousCategorie.image) %}
                                 {% else %}
                                     {% set bgColor = currentSousCategorie.couleur %}
                                 {% endif %}
                            {% elseif isArticleView %}
                                {% set photo = item.photos|first %}
                                {% if photo %}
                                    {% set imagePath = photo.thumbnailPath %}
                                {% else %}
                                    {% set bgColor = '#e9ecef' %}
                                {% endif %}
                            {% elseif isShopCategoryView %}
                                {% set bgColor = '#D19C97' %} {# Couleur "Primary" du thème (rose/rouge) #}
                            {% else %}
                                {% if item.image %}
                                     {% set folder = isSousCategorieView ? 'sous_categories' : 'categories' %}
                                     {% set imagePath = asset('uploads/images/' ~ folder ~ '/' ~ item.image) %}
                                {% else %}
                                     {% set bgColor = item.couleur %}
                                {% endif %}
                            {% endif %}

                            {% if imagePath %}
                                <div class="card-img-top d-flex align-items-center justify-content-center bg-white {{ imageClass }}" style="{{ (isSousCategorieView or isShopCategoryView or isTarifView or isArticleView) ? 'height: 100%;' : 'height: 150px;' }} overflow: hidden; {{ imageStyle }}">
                                     <img src="{{ imagePath }}" 
                                          alt="{{ item.nom }}" 
                                          class="img-fluid" 
                                          style="{{ (isSousCategorieView or isShopCategoryView or isTarifView or isArticleView) ? 'width: 100%; height: 100%; object-fit: cover;' : 'max-height: 100%; max-width: 100%;' }}">
                                </div>
                            {% else %}
                                <div class="card-img-top {{ imageClass }}" style="{{ (isSousCategorieView or isShopCategoryView or isTarifView or isArticleView) ? 'height: 100%;' : 'height: 150px;' }} background-color: {{ bgColor }}; {{ imageStyle }}">
                                    {% if isArticleView and not imagePath %}
                                        <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                                            <i class="fas fa-box fa-3x"></i>
                                        </div>
                                    {% elseif isShopCategoryView %}
                                        <div class="d-flex align-items-center justify-content-center h-100 text-white">
                                            <i class="fas fa-tags fa-3x"></i>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                            
                            {% if isTarifView %}
                                <div class="position-absolute top-0 end-0 m-2 badge bg-primary fs-5 shadow">
                                    {{ item.tarif }} €
                                </div>
                            {% elseif isArticleView %}
                                {% set firstTaille = item.tailles|first %}
                                {% if firstTaille %}
                                    <div class="position-absolute top-0 end-0 m-2 badge bg-primary fs-5 shadow">
                                        {{ firstTaille.prix }} €
                                    </div>
                                {% endif %}
                            {% endif %}
                            
                            <div class="card-img-overlay d-flex {{ (isSousCategorieView or isShopCategoryView or isTarifView or isArticleView) ? 'align-items-end pb-3' : 'align-items-center' }} justify-content-center p-2 flex-column">
                                <h6 class="card-title mb-0 fw-bold text-white text-center" style="font-variant: small-caps; text-shadow: 0 0 4px rgba(0,0,0,0.9), 0 0 8px rgba(0,0,0,0.5);">{{ item.nom }}</h6>
                                {% if isSousCategorieView and item.categorieStock is defined and item.categorieStock %}
                                    <small class="text-white text-center mt-1" style="text-shadow: 0 0 4px rgba(0,0,0,0.9);">
                                        <i class="fas fa-link me-1"></i>{{ item.categorieStock.nom }}
                                    </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="col-12">
                        <div class="alert alert-info">
                            {% if isTarifView %}
                                Aucun tarif disponible pour cette sous-catégorie.
                            {% elseif isArticleView %}
                                Aucun article disponible pour cette catégorie.
                            {% elseif isSousCategorieView %}
                                Aucune sous-catégorie disponible pour cette catégorie.
                            {% elseif isShopCategoryView %}
                                Aucune catégorie boutique trouvée.
                            {% else %}
                                Aucune catégorie de vente configurée.
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="col-3 border-start bg-light rounded shadow-sm">
            <div class="sticky-top p-3" style="top: 20px; max-height: calc(100vh - 40px); display: flex; flex-direction: column;">
                <h3 class="mb-3 text-center"><i class="fas fa-shopping-cart me-2"></i>Panier</h3>
                
                <div class="flex-grow-1 overflow-auto mb-3" style="min-height: 200px;">
                     <div id="cart-items" class="list-group">
                        <!-- Items will be added here -->
                        <div id="empty-cart-msg" class="text-center text-muted mt-5">
                            <i class="fas fa-shopping-basket fa-3x mb-3"></i>
                            <p>Votre panier est vide</p>
                        </div>
                     </div>
                </div>
                
                <div class="card bg-primary text-white mt-auto">
                    <div class="card-body text-center">
                        <h5 class="card-title">Total à payer</h5>
                        <p class="card-text display-6 fw-bold mb-2" id="cart-total">0,00 €</p>
                        <div class="mt-2 text-start">
                            <label for="client-select" class="form-label mb-1 text-white-50">Client</label>
                            <select id="client-select" placeholder="Rechercher un client..." autocomplete="off"></select>
                        </div>
                    </div>
                </div>

                <div id="payment-actions" class="mt-3 d-none">
                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" onclick="validatePayment('CB')">
                            <i class="fas fa-credit-card me-2"></i>CB
                        </button>
                        <button class="btn btn-warning btn-lg text-white" onclick="showCashInterface()">
                            <i class="fas fa-money-bill-wave me-2"></i>Espèces
                        </button>
                        <button class="btn btn-info btn-lg text-white" onclick="validatePayment('Cheque')">
                            <i class="fas fa-money-check me-2"></i>Chèque
                        </button>
                    </div>
                </div>

                <div id="cash-interface" class="card bg-warning text-white mt-3 d-none">
                    <div class="card-body">
                        <h5 class="card-title">Paiement Espèces</h5>
                        <div class="mb-3">
                            <label class="form-label">Montant perçu</label>
                            <div class="input-group input-group-lg">
                                <input type="number" id="cash-received" class="form-control" step="0.01" placeholder="0.00">
                                <span class="input-group-text">€</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">A rendre</label>
                            <div class="display-6 fw-bold" id="cash-change">0,00 €</div>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-light btn-lg fw-bold" onclick="validatePayment('Espece')">Valider</button>
                            <button class="btn btn-outline-light" onclick="hideCashInterface()">Annuler</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal PIN pour vente forcée -->
    <div class="modal fade" id="pinModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Vente forcée</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p class="small text-muted mb-2">Article en rupture de stock. Code PIN requis :</p>
            <input type="password" id="pinInput" class="form-control text-center fs-4" maxlength="4" placeholder="****">
            <div id="pinError" class="text-danger small mt-2 d-none">Code incorrect</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary w-100" id="pinConfirmBtn">Valider</button>
          </div>
        </div>
      </div>
    </div>

<script>
    let cart = [];
    let clientSelect = null;

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Client Search with TomSelect
        if(document.getElementById('client-select')) {
            clientSelect = new TomSelect('#client-select', {
                valueField: 'value',
                labelField: 'label',
                searchField: 'label',
                load: function(query, callback) {
                    var url = '{{ path("app_caisse_client_search") }}?q=' + encodeURIComponent(query);
                    fetch(url)
                        .then(response => response.json())
                        .then(json => {
                            callback(json);
                        }).catch(()=>{
                            callback();
                        });
                },
                placeholder: 'Rechercher un client...',
                maxOptions: 50
            });
        }
    });

    function addToCart(id, name, price, type, taille, isForced = false) {
        cart.push({
            id: id, 
            name: name, 
            price: parseFloat(price), 
            type: type || 'tarif', 
            taille: taille,
            isForced: isForced
        });
        updateCartDisplay();
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        updateCartDisplay();
    }

    function updateCartDisplay() {
        const cartItemsContainer = document.getElementById('cart-items');
        const emptyMsg = document.getElementById('empty-cart-msg');
        const totalEl = document.getElementById('cart-total');
        const paymentActions = document.getElementById('payment-actions');
        
        cartItemsContainer.innerHTML = '';
        let total = 0;

        if (cart.length === 0) {
            if(emptyMsg) emptyMsg.classList.remove('d-none');
            if(paymentActions) paymentActions.classList.add('d-none');
        } else {
            if(emptyMsg) emptyMsg.classList.add('d-none');
            if(paymentActions) paymentActions.classList.remove('d-none');

            cart.forEach((item, index) => {
                total += item.price;
                const itemEl = document.createElement('a');
                itemEl.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                
                let forcedBadge = '';
                if (item.isForced) {
                    forcedBadge = '<span class="badge bg-danger ms-2" title="Vente forcée (Stock 0)">!</span>';
                }
                
                itemEl.innerHTML = `
                    <div>
                        <div class="fw-bold">${item.name} ${forcedBadge}</div>
                        <div class="text-muted small">${item.price.toFixed(2)} €</div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                cartItemsContainer.appendChild(itemEl);
            });
        }

        if(totalEl) totalEl.textContent = total.toFixed(2) + ' €';
    }

    function showCashInterface() {
        const actions = document.getElementById('payment-actions');
        const interface = document.getElementById('cash-interface');
        const input = document.getElementById('cash-received');
        
        if(actions) actions.classList.add('d-none');
        if(interface) interface.classList.remove('d-none');
        if(input) input.focus();
    }

    function hideCashInterface() {
        const actions = document.getElementById('payment-actions');
        const interface = document.getElementById('cash-interface');
        
        if(interface) interface.classList.add('d-none');
        if(actions) actions.classList.remove('d-none');
    }

    // Calculate change logic
    const cashInput = document.getElementById('cash-received');
    if(cashInput) {
        cashInput.addEventListener('input', function(e) {
            const received = parseFloat(e.target.value) || 0;
            const total = cart.reduce((sum, item) => sum + item.price, 0);
            const change = received - total;
            const changeEl = document.getElementById('cash-change');
            if(changeEl) changeEl.textContent = (change > 0 ? change.toFixed(2) : '0.00') + ' €';
        });
    }

    function validatePayment(method) {
        if (cart.length === 0) return;
        
        const clientId = clientSelect ? clientSelect.getValue() : null;
        if (!clientId) {
            alert('Veuillez sélectionner un client.');
            return;
        }

        const total = cart.reduce((sum, item) => sum + item.price, 0);

        const data = {
            client: clientId,
            total: total,
            method: method,
            items: cart
        };

        fetch('{{ path("app_caisse_valider") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Vente validée avec succès !');
                cart = [];
                updateCartDisplay();
                if(clientSelect) clientSelect.clear();
                if (method === 'Espece') hideCashInterface();
            } else {
                alert('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Une erreur est survenue lors de la validation.');
        });
    }

    let pendingItem = null;

    function openPinModal(id, name, price, type, taille) {
        pendingItem = {id, name, price, type, taille};
        const modalEl = document.getElementById('pinModal');
        const modal = new bootstrap.Modal(modalEl);
        document.getElementById('pinInput').value = '';
        document.getElementById('pinError').classList.add('d-none');
        modal.show();
        
        // Focus input after modal is shown
        modalEl.addEventListener('shown.bs.modal', function () {
            document.getElementById('pinInput').focus();
        }, {once: true});
    }

    document.getElementById('pinConfirmBtn').addEventListener('click', function() {
        const pin = document.getElementById('pinInput').value;
        if (pin === '1234') {
            if (pendingItem) {
                // Pass true for isForced
                addToCart(pendingItem.id, pendingItem.name, pendingItem.price, pendingItem.type, pendingItem.taille, true);
                pendingItem = null;
            }
            const modalEl = document.getElementById('pinModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
        } else {
            document.getElementById('pinError').classList.remove('d-none');
        }
    });

    // Allow Enter key in PIN input
    document.getElementById('pinInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('pinConfirmBtn').click();
        }
    });
</script>
{% endblock %}