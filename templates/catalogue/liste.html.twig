{% extends 'base.html.twig' %}

{% block title %}
    {% if sousCategorie and categorie %}
        {{ sousCategorie.nom }} - {{ categorie.nom }}
    {% elseif sousCategorie %}
        {{ sousCategorie.nom }}
    {% elseif categorie %}
        {{ categorie.nom }}
    {% endif %} - SoSand
{% endblock %}

{% block content_right %}
    <!-- Page Header intégré dans la colonne de droite -->
    <div class="bg-secondary mb-4 p-4">
        <div class="d-flex flex-column">
            <h3 class="font-weight-semi-bold text-uppercase mb-2">
                {% if sousCategorie %}
                    {{ sousCategorie.nom }}
                {% elseif categorie %}
                    {{ categorie.nom }}
                {% endif %}
            </h3>
            <nav class="d-inline-flex">
                <a href="{{ path('app_home') }}" class="text-dark">Accueil</a>
                {% if categorie %}
                    <span class="mx-2">-</span>
                    {% if sousCategorie %}
                        <a href="{{ path('app_catalogue_categorie', {'slug': categorie.slug}) }}" class="text-dark">{{ categorie.nom }}</a>
                    {% else %}
                        <span class="text-dark">{{ categorie.nom }}</span>
                    {% endif %}
                {% endif %}
                {% if sousCategorie %}
                    <span class="mx-2">-</span>
                    <span class="text-dark">{{ sousCategorie.nom }}</span>
                {% endif %}
            </nav>
        </div>
    </div>
    
    <!-- Products List -->
    <div class="row pb-3">
        <div class="col-12 pb-1 mb-3">
            <h5 class="text-dark mb-0">
                {{ articles|length }} article{% if articles|length > 1 %}s{% endif %} trouvé{% if articles|length > 1 %}s{% endif %}
            </h5>
        </div>
        
        {% if articles|length > 0 %}
            {% for article in articles %}
                {% set minPrice = null %}
                {% set minBarredPrice = null %}
                {% set taillesCount = article.tailles|length %}
                
                {# Trouver le prix le plus bas et son prix barré correspondant #}
                {% for taille in article.tailles %}
                    {% if minPrice is null or taille.prix < minPrice %}
                        {% set minPrice = taille.prix %}
                        {% set minBarredPrice = taille.barre is defined and taille.barre ? taille.barre : null %}
                    {% endif %}
                {% endfor %}
                
                {# Calculer le pourcentage de réduction #}
                {% set discount = null %}
                {% if minBarredPrice and minPrice %}
                    {% set discount = ((minBarredPrice - minPrice) / minBarredPrice * 100)|round %}
                {% endif %}
                
                <div class="col-lg-3 col-md-4 col-sm-6 pb-1">
                    <div class="card product-item border-0 mb-4">
                        <div class="card-header product-img position-relative overflow-hidden bg-transparent border p-0">
                            <a href="{{ path('app_article_show', {'slug': article.slug}) }}">
                                {% if article.photos|length > 0 %}
                                    <img class="img-fluid w-100" src="{{ asset('assets/img/articles/' ~ article.id ~ '/' ~ article.photos|first.filename) }}" alt="{{ article.nom }}" style="object-fit: cover; height: 300px;">
                                {% else %}
                                    <img class="img-fluid w-100" src="{{ asset('assets/img/product-1.jpg') }}" alt="{{ article.nom }}" style="object-fit: cover; height: 300px;">
                                {% endif %}
                            </a>
                            
                            {# Badge sous-catégorie ou catégorie à gauche #}
                            {% if article.sousCategorie %}
                                <div class="badge badge-secondary text-white position-absolute" style="top: 10px; left: 10px; padding: 5px 10px;">
                                    {{ article.sousCategorie.nom }}
                                </div>
                            {% elseif article.categorie %}
                                <div class="badge badge-secondary text-white position-absolute" style="top: 10px; left: 10px; padding: 5px 10px;">
                                    {{ article.categorie.nom }}
                                </div>
                            {% endif %}
                            
                            {# Badge réduction à droite #}
                            {% if discount %}
                                <div class="badge badge-danger text-white position-absolute" style="top: 10px; right: 10px; padding: 5px 10px; font-size: 14px;">
                                    -{{ discount }}%
                                </div>
                            {% endif %}
                            
                            {# Cœur favori en bas à droite #}
                            {% set isFavori = favoriService.estDansFavoris(article) %}
                            {% if isFavori %}
                                {% set heartIcon = 'fas' %}
                                {% set heartColor = '#dc3545' %}
                            {% else %}
                                {% set heartIcon = 'far' %}
                                {% set heartColor = '#6c757d' %}
                            {% endif %}
                            <button type="button" 
                                    class="btn btn-sm position-absolute favori-btn" 
                                    style="bottom: 10px; right: 10px; background: white; border-radius: 50%; width: 40px; height: 40px; padding: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"
                                    data-article-id="{{ article.id }}"
                                    onclick="toggleFavori({{ article.id }}, this)">
                                <i class="{{ heartIcon }} fa-heart" style="font-size: 18px; color: {{ heartColor }};"></i>
                            </button>
                        </div>
                        <div class="card-body border-left border-right text-center p-0 pt-4 pb-3">
                            <h6 class="text-truncate mb-3">{{ article.nom }}</h6>
                            <div class="d-flex justify-content-center">
                                {% if minPrice %}
                                    <h6>
                                        {% if taillesCount > 1 %}A partir de {% endif %}
                                        {{ minPrice|number_format(2, ',', ' ') }}€
                                    </h6>
                                    {% if minBarredPrice %}
                                        <h6 class="text-muted ml-2"><del>{{ minBarredPrice|number_format(2, ',', ' ') }}€</del></h6>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-footer d-flex justify-content-center bg-light border">
                            <a href="{{ path('app_article_show', {'slug': article.slug}) }}" class="btn btn-sm text-dark p-0"><i class="fas fa-eye text-primary mr-1"></i>Voir détails</a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle mr-2"></i>
                    Aucun article trouvé dans cette catégorie pour le moment.
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}
